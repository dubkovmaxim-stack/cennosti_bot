"""
üéØ –¶–ï–ù–ù–û–°–¢–ù–´–ô –ù–ê–í–ò–ì–ê–¢–û–† 4.0 - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã –∞–Ω–∞–ª–∏–∑–∞ (42000+ —Å–∏–º–≤–æ–ª–æ–≤)
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚Ä¢ –ú–µ—Ö–∞–Ω–∏–∫–∞: 40√ó1 –∏–∑ 5 ‚Üí 10√ó1 –∏–∑ 4
‚Ä¢ –®–∞—Ä–∏–Ω–≥ –±–æ—Ç–∞ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
"""

import json
import random
import asyncio
import logging
import sys
import os
import pickle
import time
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Set, Tuple, Any
from dataclasses import dataclass, field, asdict
from enum import Enum
import hashlib

# –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
try:
    from aiogram import Bot, Dispatcher, types, F
    from aiogram.filters import Command
    from aiogram.types import (
        ReplyKeyboardMarkup, 
        KeyboardButton, 
        ReplyKeyboardRemove,
        InlineKeyboardMarkup,
        InlineKeyboardButton
    )
    from aiogram.enums import ParseMode
    from aiogram.client.default import DefaultBotProperties
    from aiogram.fsm.context import FSMContext
    from aiogram.fsm.state import State, StatesGroup
    from aiogram.fsm.storage.memory import MemoryStorage
    from aiogram.fsm.storage.base import StorageKey
except ImportError:
    print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install aiogram aiohttp")
    input("–ù–∞–∂–º–∏—Ç–µ Enter...")
    sys.exit(1)

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = os.getenv("BOT_TOKEN", "8414114962:AAHDuiIPohDnF9PDgvlLu3IOomDksMhWPXk")
ADMIN_ID = int(os.getenv("ADMIN_ID", "1374636462"))
BOT_NAME = os.getenv("BOT_NAME", "–¶–µ–Ω–Ω–æ—Å—Ç–Ω—ã–π –ù–∞–≤–∏–≥–∞—Ç–æ—Ä")
ENVIRONMENT = os.getenv("ENVIRONMENT", "production")

# –¢–∞–π–º–∞—É—Ç—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
TIMEOUT_REMINDER = 120  # 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
TIMEOUT_RESTART = 300   # 5 –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
CHECK_INTERVAL = 30     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('bot_errors.log', encoding='utf-8')
    ]
)
logger = logging.getLogger(__name__)

# ========== –ó–ê–ì–†–£–ó–ö–ê –¶–ï–ù–ù–û–°–¢–ï–ô ==========
try:
    with open('values.json', 'r', encoding='utf-8') as f:
        VALUES_DATA = json.load(f)
    
    if isinstance(VALUES_DATA, dict) and "values" in VALUES_DATA:
        ALL_VALUES = VALUES_DATA["values"]
    elif isinstance(VALUES_DATA, list):
        ALL_VALUES = VALUES_DATA
    else:
        ALL_VALUES = []
    
    logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(ALL_VALUES)} —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π")
    VALUE_BY_ID = {v["id"]: v for v in ALL_VALUES}
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    CATEGORIES = {}
    for value in ALL_VALUES:
        cat = value.get('category', '–†–∞–∑–Ω–æ–µ')
        if cat not in CATEGORIES:
            CATEGORIES[cat] = []
        CATEGORIES[cat].append(value)
    
    logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(CATEGORIES)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
    
except Exception as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ values.json: {e}")
    ALL_VALUES = []
    VALUE_BY_ID = {}
    CATEGORIES = {}

# ========== –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–†–û–ì–†–ï–°–°–ê ==========
@dataclass
class GameProgress:
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–≥—Ä—ã"""
    user_id: int
    username: str
    stage: int = 1
    round: int = 0
    stage1_selected: List[int] = field(default_factory=list)  # ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
    stage2_selected: List[int] = field(default_factory=list)
    current_group: List[int] = field(default_factory=list)
    used_ids: Set[int] = field(default_factory=set)
    psychological_profile: Optional[str] = None
    user_goals: str = ""
    start_time: str = field(default_factory=lambda: datetime.now().isoformat())
    last_activity: str = field(default_factory=lambda: datetime.now().isoformat())
    badges: List[str] = field(default_factory=list)
    stats: Dict[str, Any] = field(default_factory=lambda: {
        "total_choices": 0,
        "avg_response_time": 0,
        "errors": 0,
        "skipped_rounds": 0
    })
    
    def to_dict(self):
        return {
            "user_id": self.user_id,
            "username": self.username,
            "stage": self.stage,
            "round": self.round,
            "stage1_selected": self.stage1_selected,
            "stage2_selected": self.stage2_selected,
            "current_group": self.current_group,
            "used_ids": list(self.used_ids),
            "psychological_profile": self.psychological_profile,
            "user_goals": self.user_goals,
            "start_time": self.start_time,
            "last_activity": self.last_activity,
            "badges": self.badges,
            "stats": self.stats
        }
    
    @classmethod
    def from_dict(cls, data):
        return cls(
            user_id=data["user_id"],
            username=data["username"],
            stage=data.get("stage", 1),
            round=data.get("round", 0),
            stage1_selected=data.get("stage1_selected", []),
            stage2_selected=data.get("stage2_selected", []),
            current_group=data.get("current_group", []),
            used_ids=set(data.get("used_ids", [])),
            psychological_profile=data.get("psychological_profile"),
            user_goals=data.get("user_goals", ""),
            start_time=data.get("start_time", datetime.now().isoformat()),
            last_activity=data.get("last_activity", datetime.now().isoformat()),
            badges=data.get("badges", []),
            stats=data.get("stats", {
                "total_choices": 0,
                "avg_response_time": 0,
                "errors": 0,
                "skipped_rounds": 0
            })
        )

class ProgressStorage:
    """–•—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    def __init__(self, filename="progress_data.pkl"):
        self.filename = filename
        self.data: Dict[int, GameProgress] = self._load()
    
    def _load(self) -> Dict[int, GameProgress]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            if os.path.exists(self.filename):
                with open(self.filename, 'rb') as f:
                    raw_data = pickle.load(f)
                    return {k: GameProgress.from_dict(v) for k, v in raw_data.items()}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: {e}")
        return {}
    
    def save(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª"""
        try:
            raw_data = {k: v.to_dict() for k, v in self.data.items()}
            with open(self.filename, 'wb') as f:
                pickle.dump(raw_data, f)
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            backup_name = f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pkl"
            with open(backup_name, 'wb') as f:
                pickle.dump(raw_data, f)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: {e}")
    
    def get(self, user_id: int) -> Optional[GameProgress]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return self.data.get(user_id)
    
    def set(self, user_id: int, progress: GameProgress):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.data[user_id] = progress
        self.save()
    
    def delete(self, user_id: int):
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.data:
            del self.data[user_id]
            self.save()
    
    def update_activity(self, user_id: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        if user_id in self.data:
            self.data[user_id].last_activity = datetime.now().isoformat()
            self.save()
    
    def cleanup_old_sessions(self, hours: int = 24):
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π"""
        cutoff = datetime.now() - timedelta(hours=hours)
        to_delete = []
        
        for user_id, progress in self.data.items():
            last_active = datetime.fromisoformat(progress.last_activity)
            if last_active < cutoff:
                to_delete.append(user_id)
        
        for user_id in to_delete:
            del self.data[user_id]
        
        if to_delete:
            self.save()
            logger.info(f"–û—á–∏—â–µ–Ω–æ {len(to_delete)} —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π")

# ========== –ë–ê–ó–ê –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–• –ê–ù–ê–õ–ò–ó–û–í ==========
DEEP_STRENGTHS_ANALYSIS = {
    '–±–∞–ª–∞–Ω—Å': [
        """–ì–ê–†–ú–û–ù–ò–ó–ê–¶–ò–Ø –ü–†–û–¢–ò–í–û–ü–û–õ–û–ñ–ù–û–°–¢–ï–ô - –í–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–µ–¥–∫—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∑–∞–ª–æ—Å—å –±—ã, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É –∞—Å–ø–µ–∫—Ç—ã: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–æ—Å—Ç, –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ –∏ —Å–æ–∑–µ—Ä—Ü–∞–Ω–∏–µ. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤—ã—Å–æ–∫–æ—Ä–∞–∑–≤–∏—Ç—É—é ¬´–∏–Ω—Ç–µ–≥—Ä–∞—Ç–∏–≤–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å¬ª (Suedfeld, 2010) - –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —á–µ–ª–æ–≤–µ–∫ —Å–ø–æ—Å–æ–±–µ–Ω —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤ —Å–æ–∑–Ω–∞–Ω–∏–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Ö —É–ø—Ä–æ—â–µ–Ω–∏—è –∏–ª–∏ –ø–æ–ª—è—Ä–∏–∑–∞—Ü–∏–∏. 

–ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥–Ω–µ–π –ø–æ—è—Å–Ω–æ–π –∫–æ—Ä—ã (ACC) - –æ–±–ª–∞—Å—Ç–∏ –º–æ–∑–≥–∞, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏–∑–±–µ–≥–∞–µ—Ç–µ –∫—Ä–∞–π–Ω–æ—Å—Ç–µ–π, –Ω–∞—Ö–æ–¥—è —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö, –≥–¥–µ –¥—Ä—É–≥–∏–µ —Å–∫–ª–æ–Ω–Ω—ã –∫ —á–µ—Ä–Ω–æ-–±–µ–ª–æ–º—É –º—ã—à–ª–µ–Ω–∏—é.""",
        
        """–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –ì–ò–ë–ö–û–°–¢–¨ –ò –†–ï–°–£–†–°–ù–û–°–¢–¨ - –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–∏–π—Å—è –≤—ã—Å–æ–∫–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å—é - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é —Ä–∞–∑–ª–∏—á–∞—Ç—å –∏ —Ç–æ—á–Ω–æ –Ω–∞–∑—ã–≤–∞—Ç—å —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π. 
        
–≠—Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ, —Å–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º –ë–∞—Ä—Ä–µ—Ç—Ç (2017), —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –ø—Ä–µ–¥–∏–∫—Ç–æ—Ä–æ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –∞ –Ω–µ –ø–æ–¥–∞–≤–ª—è—Ç—å –∏–ª–∏ –∏–∑–±–µ–≥–∞—Ç—å –∏—Ö. 

–í–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ¬´–±—É—Ñ–µ—Ä–Ω—ã–π —Ä–µ–∑–µ—Ä–≤—É–∞—Ä¬ª, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≥–æ—Ä–∞–Ω–∏—è –∏ —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ. –ù–µ–π—Ä–æ—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–Ω–¥–∞–ª–µ–≤–∏–¥–Ω–æ–≥–æ —Ç–µ–ª–∞ –∏ –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä—ã.""",
        
        """–°–ò–°–¢–ï–ú–ù–û–ï –í–ò–î–ï–ù–ò–ï –ò –ö–û–ù–¢–ï–ö–°–¢–£–ê–õ–¨–ù–û–ï –ú–´–®–õ–ï–ù–ò–ï - –í–∞—à –≤—ã–±–æ—Ä —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –∂–∏–∑–Ω—å –∫–∞–∫ —Ü–µ–ª–æ—Å—Ç–Ω—É—é —Å–∏—Å—Ç–µ–º—É –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –≥–¥–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–π —Å—Ñ–µ—Ä–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ. 
        
–≠—Ç–∞ –º–µ—Ç–∞–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –∏–∑–≤–µ—Å—Ç–Ω–∞—è –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –∫–∞–∫ ¬´—Å–∏—Å—Ç–µ–º–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ¬ª (Senge, 1990), –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º –ø—Ä–µ–¥–≤–∏–¥–µ—Ç—å –æ—Ç–¥–∞–ª–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–µ—à–µ–Ω–∏–π –∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏, –∞ –Ω–µ —Å–∏—Ç—É–∞—Ç–∏–≤–Ω–æ. 

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –≤–∞–∂–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ —Å—Ñ–µ—Ä–∞–º–∏ –∏ —Å–ø–æ—Å–æ–±–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–∏—é–º–∏–Ω—É—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è."""
    ],
    
    '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è': [
        """–¶–ï–õ–ï–í–ê–Ø –û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ò –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–û–ô–ß–ò–í–û–°–¢–¨ - –í–∞—à–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–∞–∑–≤–∏—Ç—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º—É –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—é –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º—É –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´–±—É–¥—É—â–µ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã¬ª (Zimbardo, 1999), –≥–¥–µ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã—Ö —Ü–µ–ª–µ–π –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –¥–æ—Ä—Å–æ–ª–∞—Ç–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä—ã - –æ–±–ª–∞—Å—Ç–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞–±–æ—á—É—é –ø–∞–º—è—Ç—å –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å.

–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –∞–º–±–∏—Ü–∏–æ–∑–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∞–ª–∏–∑–º–∞: —Ü–µ–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—ã—Å–æ–∫–∏, —á—Ç–æ–±—ã –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –≥–¥–µ —É—Å–ø–µ—Ö —É–∫—Ä–µ–ø–ª—è–µ—Ç —Å–∞–º–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, –ø–æ–≤—ã—à–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±—É–¥—É—â–∏—Ö —É—Å–ø–µ—Ö–æ–≤.""",
        
        """–ê–î–ê–ü–¢–ò–í–ù–´–ô –ü–ï–†–§–ï–ö–¶–ò–û–ù–ò–ó–ú –ò –†–û–°–¢–û–í–û–ï –ú–´–®–õ–ï–ù–ò–ï - –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥–µ–∑–∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–∞, –≤–µ–¥—É—â–µ–≥–æ –∫ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏ –∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—é, –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç—Ä–∞–∂–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ. 
        
–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ö–∞—Ä–æ–ª–∞ –î—É—ç–∫ –æ ¬´—Ä–æ—Å—Ç–æ–≤–æ–º –º—ã—à–ª–µ–Ω–∏–∏¬ª - —É–±–µ–∂–¥–µ–Ω–∏–∏, —á—Ç–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ —É—Å–∏–ª–∏—è –∏ –æ–±—É—á–µ–Ω–∏–µ. –í–∞—à–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –æ—Å–Ω–æ–≤—É –¥–ª—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –Ω–µ—É–¥–∞—á –∫–∞–∫ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, –∞ –Ω–µ –∫–∞–∫ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–∞ –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

–ù–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π, –ø–æ—Å–∫–æ–ª—å–∫—É –º–æ–∑–≥ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã –∫–∞–∫ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è, –∞ –Ω–µ –∫–∞–∫ —É–≥—Ä–æ–∑—ã. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é –∫ —Ä–∞–∑–≤–∏—Ç–∏—é, –Ω–µ –∑–∞–≤–∏—Å—è—â—É—é –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è –∏–ª–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.""",
        
        """–°–ê–ú–û–†–ï–ì–£–õ–Ø–¶–ò–Ø –ò –ú–ï–¢–ê–ö–û–ì–ù–ò–¢–ò–í–ù–´–ô –ö–û–ù–¢–†–û–õ–¨ - –í–∞—à –≤—ã–±–æ—Ä —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–∞–∑–≤–∏—Ç—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –º–µ—Ç–∞–ø–æ–∑–Ω–∞–Ω–∏—é - –æ—Å–æ–∑–Ω–∞–Ω–∏—é –∏ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º—ã—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. 
        
–≠—Ç–∞ –≤—ã—Å—à–∞—è –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ñ–æ–∫—É—Å –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ—Ç–≤–ª–µ–∫–∞—é—â–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –∫–æ–Ω—Ü–µ–ø—Ü–∏–µ–π ¬´—É–º—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞¬ª - —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π.

–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —É–ø–æ—Ä—Å—Ç–≤–æ–º –∏ –≥–∏–±–∫–æ—Å—Ç—å—é: —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Ü–µ–ª–∏, –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–≤–∞—è—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –≠—Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Å–æ–±–µ–Ω–Ω–æ —Ü–µ–Ω–Ω–æ –≤ –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è—é—â–∏—Ö—Å—è —É—Å–ª–æ–≤–∏—è—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∏—Ä–∞."""
    ]
}

DEEP_ENERGY_DISTRIBUTION = {
    '–±–∞–ª–∞–Ω—Å': [
        """–í–ù–£–¢–†–ï–ù–ù–Ø–Ø –ì–ê–†–ú–û–ù–ò–ó–ê–¶–ò–Ø (35% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´—ç–≤–¥–µ–º–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è¬ª (Ryan & Deci, 2001), –≥–¥–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–µ –æ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Ü–µ–ª–µ–π, –∞ –æ—Ç –æ—â—É—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ü–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é —Å–µ—Ç–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –º–æ–∑–≥–∞ (default mode network), –∫–æ—Ç–æ—Ä–∞—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø—ã—Ç–∞.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏, —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ä–µ–≥—É–ª—è—Ü–∏–∏. –û–Ω —Å–ª—É–∂–∏—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö –¥—Ä—É–≥–∏—Ö —Å—Ñ–µ—Ä, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ —Ä–µ—Å—É—Ä—Å–Ω–æ—Å—Ç—å. –ë–µ–∑ —ç—Ç–æ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –≤–Ω–µ—à–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—â—É—â–∞—Ç—å—Å—è –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ –ø—Ä–∏–≤–æ–¥—è—â–∏–º–∏ –∫ –≤—ã–≥–æ—Ä–∞–Ω–∏—é.""",
        
        """–°–û–¶–ò–ê–õ–¨–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø (30% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç –ø–æ—Ç–æ–∫ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —á—É–≤—Å—Ç–≤–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –≤–∑–∞–∏–º–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏. 
        
–° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (Bowlby, 1969), —ç—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–∏–ø –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—é—â–∏–π—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –±–ª–∏–∑–∫–∏–µ —Å–≤—è–∑–∏ –±–µ–∑ —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –∏–∑–±–µ–≥–∞–Ω–∏—è. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç —Å–∏—Å—Ç–µ–º—É –æ–∫—Å–∏—Ç–æ—Ü–∏–Ω–∞, —Å–Ω–∏–∂–∞—è —É—Ä–æ–≤–µ–Ω—å –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ –∏ –ø–æ–≤—ã—à–∞—è –æ—â—É—â–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤–Ω–∏–º–∞–Ω–∏—è –≤ –∑–Ω–∞—á–∏–º—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ä–∞–∑–≤–∏—Ç–∏–∏ —ç–º–ø–∞—Ç–∏–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤. –û–Ω —Å–æ–∑–¥–∞–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª - —Å–µ—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä–∞—è —Å–ª—É–∂–∏—Ç –±—É—Ñ–µ—Ä–æ–º –ø—Ä–æ—Ç–∏–≤ —Å—Ç—Ä–µ—Å—Å–∞ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ä–æ—Å—Ç–∞ –∏ —Ä–∞–∑–≤–∏—Ç–∏—è.""",
        
        """–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (35% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç –ø–æ—Ç–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´—Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏¬ª (Maslow, 1954) - —Å—Ç—Ä–µ–º–ª–µ–Ω–∏—é –∫ –ø–æ–ª–Ω–æ–º—É —Ä–∞—Å–∫—Ä—ã—Ç–∏—é —Å–≤–æ–µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —á–µ—Ä–µ–∑ –∑–Ω–∞—á–∏–º—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –¥–æ—Ñ–∞–º–∏–Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é —Ü–µ–ª–µ–π –∏ –ø–æ–ª—É—á–µ–Ω–∏—é –Ω–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π, —Ä–∞–∑–≤–∏—Ç–∏–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–∫–ª–∞–¥–∞ –≤ –º–∏—Ä, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º —Å–º—ã—Å–ª–∞ –∂–∏–∑–Ω–∏ –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏."""
    ],
    
    '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è': [
        """–°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–û–ï –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –ò –¶–ï–õ–ï–ü–û–õ–ê–ì–ê–ù–ò–ï (40% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —è—Å–Ω–æ–π –∫–∞—Ä—Ç—ã –±—É–¥—É—â–µ–≥–æ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö —Ü–µ–ª–µ–π. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´—É–ø—Ä–µ–∂–¥–∞—é—â–µ–≥–æ —Å–æ–≤–ª–∞–¥–∞–Ω–∏—è¬ª (Aspinwall & Taylor, 1997) - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–≤–∏–¥–µ—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ –∑–∞—Ä–∞–Ω–µ–µ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏—Ö –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø—Ä–µ—Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–æ—Ä—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–æ—Ä—Å–æ–ª–∞—Ç–µ—Ä–∞–ª—å–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏, –∞–Ω–∞–ª–∏–∑–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –û–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∞–º–±–∏—Ü–∏–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –∏–∑–º–µ—Ä–∏–º—ã–µ –∏ –¥–æ—Å—Ç–∏–∂–∏–º—ã–µ —à–∞–≥–∏, —Å–Ω–∏–∂–∞—è –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–≤—ã—à–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.""",
        
        """–†–ê–ó–í–ò–¢–ò–ï –≠–ö–°–ü–ï–†–¢–ò–ó–´ –ò –ú–ê–°–¢–ï–†–°–¢–í–ê (35% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π, –Ω–∞–≤—ã–∫–æ–≤ –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´—Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏¬ª (Ericsson, 1993) - —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–¥—Ö–æ–¥—É –∫ —Ä–∞–∑–≤–∏—Ç–∏—é –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –º–∏–µ–ª–∏–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏, –ø–æ–∏—Å–∫–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–∞, –∞–Ω–∞–ª–∏–∑–µ –æ—à–∏–±–æ–∫ –∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –û–Ω —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—á–Ω—É—é –æ—Å–Ω–æ–≤—É –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É—é –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –Ω–∞ —Ä—ã–Ω–∫–µ.""",
        
        """–û–ü–ï–†–ê–¶–ò–û–ù–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ê–î–ê–ü–¢–ê–¶–ò–Ø (25% —ç–Ω–µ—Ä–≥–∏–∏) - –≠—Ç–æ—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∏ –≥–∏–±–∫—É—é –∞–¥–∞–ø—Ç–∞—Ü–∏—é –∫ –∏–∑–º–µ–Ω—è—é—â–∏–º—Å—è –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞–º. 
        
–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ¬´—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è¬ª (Gollwitzer, 1999) - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–µ—Å–ª–∏-—Ç–æ¬ª, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö. –ù–µ–π—Ä–æ–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–∞ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –±–∞–∑–∞–ª—å–Ω—ã—Ö –≥–∞–Ω–≥–ª–∏–µ–≤ - —Å—Ç—Ä—É–∫—Ç—É—Ä, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.

–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–¥–∞—á, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–µ–º –∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∞ —Ç–∞–∫–∂–µ –≤ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–∞–∂–µ –≤ —É—Å–ª–æ–≤–∏—è—Ö –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤."""
    ]
}

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø FSM ==========
class GameStates(StatesGroup):
    waiting_start = State()
    stage1_round = State()
    stage2_round = State()
    asking_goals = State()
    generating_analysis = State()
    showing_analysis = State()

# ========== –°–ò–°–¢–ï–ú–ê –¢–ê–ô–ú–ê–£–¢–û–í –ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ==========
class TimeoutManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏"""
    
    def __init__(self):
        self.user_timeouts: Dict[int, Dict[str, Any]] = {}  # user_id -> –¥–∞–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç–∞
        self.reminder_tasks: Dict[int, asyncio.Task] = {}
    
    async def start_timeout_check(self, user_id: int, state: FSMContext, bot: Bot):
        """–ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.reminder_tasks:
            self.reminder_tasks[user_id].cancel()
        
        self.user_timeouts[user_id] = {
            "start_time": datetime.now(),
            "last_reminder": None,
            "state": state,
            "bot": bot
        }
        
        task = asyncio.create_task(self._check_user_timeout(user_id))
        self.reminder_tasks[user_id] = task
    
    async def _check_user_timeout(self, user_id: int):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            while True:
                await asyncio.sleep(CHECK_INTERVAL)
                
                if user_id not in self.user_timeouts:
                    break
                
                timeout_data = self.user_timeouts[user_id]
                elapsed = (datetime.now() - timeout_data["start_time"]).seconds
                
                # –ü–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
                if elapsed >= TIMEOUT_REMINDER and timeout_data.get("last_reminder") is None:
                    await self._send_reminder(user_id, timeout_data, "first")
                    timeout_data["last_reminder"] = datetime.now()
                
                # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
                elif elapsed >= TIMEOUT_RESTART and timeout_data.get("last_reminder") is not None:
                    reminder_elapsed = (datetime.now() - timeout_data["last_reminder"]).seconds
                    if reminder_elapsed >= 60:  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø–æ—Å–ª–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                        await self._send_reminder(user_id, timeout_data, "restart")
                        # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                        if user_id in self.user_timeouts:
                            del self.user_timeouts[user_id]
                        break
                
        except asyncio.CancelledError:
            pass
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–π–º–∞—É—Ç–∞: {e}")
    
    async def _send_reminder(self, user_id: int, timeout_data: Dict[str, Any], reminder_type: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
        try:
            bot = timeout_data["bot"]
            
            if reminder_type == "first":
                message = (
                    "‚è∞ <b>–í—ã –≤—Å–µ –µ—â–µ –∑–¥–µ—Å—å?</b>\n\n"
                    "–Ø –≤–∏–∂—É, —á—Ç–æ –≤—ã –Ω–∞—á–∞–ª–∏ –≤—ã–±–∏—Ä–∞—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å. "
                    "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É?\n\n"
                    "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å."
                )
            else:  # reminder_type == "restart"
                message = (
                    "üîÑ <b>–ü–æ—Ö–æ–∂–µ, –≤—ã –æ—Ç–≤–ª–µ–∫–ª–∏—Å—å</b>\n\n"
                    "–ü—Ä–æ—à–ª–æ —É–∂–µ 5 –º–∏–Ω—É—Ç –±–µ–∑ –æ—Ç–≤–µ—Ç–∞. "
                    "–ú–æ–∂–µ—Ç, –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã?\n\n"
                    "–ù–∞–∂–º–∏—Ç–µ üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ."
                )
            
            await bot.send_message(
                chat_id=user_id,
                text=message,
                parse_mode=ParseMode.HTML,
                reply_markup=ReplyKeyboardRemove()
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")
    
    def stop_timeout_check(self, user_id: int):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞"""
        if user_id in self.reminder_tasks:
            self.reminder_tasks[user_id].cancel()
            del self.reminder_tasks[user_id]
        
        if user_id in self.user_timeouts:
            del self.user_timeouts[user_id]

# ========== –ö–õ–ê–°–° –ò–ì–†–´ –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –ü–†–û–ì–†–ï–°–°–ê ==========
class ValueGame:
    def __init__(self, user_id: int, username: str, storage: ProgressStorage):
        self.user_id = user_id
        self.username = username
        self.storage = storage
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        self.progress = storage.get(user_id)
        if not self.progress:
            self.progress = GameProgress(user_id, username)
            self._initialize_new_game()
        else:
            self._load_from_progress()
    
    def _initialize_new_game(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã"""
        self.all_values = ALL_VALUES.copy()
        random.shuffle(self.all_values)
        
        # –ú–µ—Ö–∞–Ω–∏–∫–∞: 40 —Ä–∞—É–Ω–¥–æ–≤ √ó 1 –∏–∑ 5 ‚Üí 10 —Ä–∞—É–Ω–¥–æ–≤ √ó 1 –∏–∑ 4
        self.total_rounds_stage1 = 40
        self.total_rounds_stage2 = 10
        
        self.available_values = self.all_values.copy()
        self.stage2_by_category = {}
        
        self.progress.start_time = datetime.now().isoformat()
        self._update_activity()
    
    def _load_from_progress(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        self.all_values = ALL_VALUES.copy()
        self.available_values = [v for v in self.all_values if v["id"] not in self.progress.used_ids]
        
        self.total_rounds_stage1 = 40
        self.total_rounds_stage2 = 10
        
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º stage2_by_category –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if self.progress.stage == 2 and not hasattr(self, 'stage2_by_category'):
            self._reconstruct_stage2_categories()
    
    def _reconstruct_stage2_categories(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —ç—Ç–∞–ø–∞ 2"""
        self.stage2_by_category = {}
        stage1_values = [VALUE_BY_ID[id] for id in self.progress.stage1_selected if id in VALUE_BY_ID]
        
        for value in stage1_values:
            cat = value.get('category', '–†–∞–∑–Ω–æ–µ')
            if cat not in self.stage2_by_category:
                self.stage2_by_category[cat] = []
            self.stage2_by_category[cat].append(value)
    
    def _update_activity(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        self.progress.last_activity = datetime.now().isoformat()
        self.storage.update_activity(self.user_id)
    
    def _update_stats(self, choice_time: float = None, error: bool = False, skipped: bool = False):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        self.progress.stats["total_choices"] += 1
        
        if error:
            self.progress.stats["errors"] += 1
        if skipped:
            self.progress.stats["skipped_rounds"] += 1
        
        if choice_time:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
            total = self.progress.stats["total_choices"]
            old_avg = self.progress.stats["avg_response_time"]
            self.progress.stats["avg_response_time"] = (old_avg * (total - 1) + choice_time) / total
        
        self._save_progress()
    
    def _save_progress(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        self.progress.current_group = [v["id"] for v in getattr(self, 'current_group', [])]
        self.progress.used_ids = getattr(self, 'used_ids', set())
        
        self.storage.set(self.user_id, self.progress)
    
    def get_available_for_stage1(self) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–∞–ø–∞ 1"""
        available = [v for v in self.available_values if v["id"] not in self.progress.used_ids]
        return available
    
    def prepare_stage1_round(self) -> bool:
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞—É–Ω–¥–∞ –¥–ª—è —ç—Ç–∞–ø–∞ 1 (–≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 5)"""
        if len(self.progress.stage1_selected) >= self.total_rounds_stage1:
            return False
        
        available = self.get_available_for_stage1()
        
        if len(available) < 5:
            return False
        
        # –í—ã–±–∏—Ä–∞–µ–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        self.current_group = random.sample(available, 5)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        self.progress.current_group = [v["id"] for v in self.current_group]
        
        # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ
        for value in self.current_group:
            self.progress.used_ids.add(value["id"])
        
        self.progress.round += 1
        self._update_activity()
        self._save_progress()
        
        return True
    
    def process_stage1_choice(self, choice_index: int) -> bool:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞ —ç—Ç–∞–ø–µ 1"""
        if not (0 <= choice_index < len(self.current_group)):
            self._update_stats(error=True)
            return False
        
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å
            selected_value = self.current_group[choice_index]
            self.progress.stage1_selected.append(selected_value["id"])
            
            # –£–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
            if selected_value in self.available_values:
                self.available_values.remove(selected_value)
            
            # –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –≥—Ä—É–ø–ø—É
            self.current_group = []
            self.progress.current_group = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –≤–µ—Ö–∏
            if len(self.progress.stage1_selected) % 10 == 0:
                self._add_badge(f"–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å {len(self.progress.stage1_selected)//10} —É—Ä–æ–≤–Ω—è")
            
            self._update_activity()
            self._save_progress()
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞: {e}")
            self._update_stats(error=True)
            return False
    
    def prepare_stage2_round(self) -> bool:
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞—É–Ω–¥–∞ –¥–ª—è —ç—Ç–∞–ø–∞ 2 (–≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 4 –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)"""
        if len(self.progress.stage2_selected) >= self.total_rounds_stage2:
            return False
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞—É–Ω–¥ —ç—Ç–∞–ø–∞ 2, –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        if not self.stage2_by_category:
            self._group_stage1_values_by_category()
        
        # –í—ã–±–∏—Ä–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–Ω–∞—á–µ–Ω–∏–π
        available_categories = []
        for cat, values in self.stage2_by_category.items():
            if len(values) >= 2:
                available_categories.append((cat, values))
        
        if not available_categories:
            return False
        
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        selected_cat, cat_values = random.choice(available_categories)
        
        # –ë–µ—Ä–µ–º 4 —Å–ª—É—á–∞–π–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        sample_size = min(4, len(cat_values))
        self.current_group = random.sample(cat_values, sample_size)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        self.progress.current_group = [v["id"] for v in self.current_group]
        
        # –£–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        for value in self.current_group:
            if value in self.stage2_by_category[selected_cat]:
                self.stage2_by_category[selected_cat].remove(value)
        
        # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ–ø—É—Å—Ç–µ–ª–∞, —É–¥–∞–ª—è–µ–º –µ–µ
        if not self.stage2_by_category[selected_cat]:
            del self.stage2_by_category[selected_cat]
        
        self.progress.round += 1
        self._update_activity()
        self._save_progress()
        
        return True
    
    def _group_stage1_values_by_category(self):
        """–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è —ç—Ç–∞–ø–∞ 1 –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è —ç—Ç–∞–ø–∞ 2"""
        self.stage2_by_category = {}
        stage1_values = [VALUE_BY_ID[id] for id in self.progress.stage1_selected if id in VALUE_BY_ID]
        
        for value in stage1_values:
            cat = value.get('category', '–†–∞–∑–Ω–æ–µ')
            if cat not in self.stage2_by_category:
                self.stage2_by_category[cat] = []
            self.stage2_by_category[cat].append(value)
    
    def process_stage2_choice(self, choice_index: int) -> bool:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞ —ç—Ç–∞–ø–µ 2"""
        if not (0 <= choice_index < len(self.current_group)):
            self._update_stats(error=True)
            return False
        
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å
            selected_value = self.current_group[choice_index]
            self.progress.stage2_selected.append(selected_value["id"])
            
            # –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –≥—Ä—É–ø–ø—É
            self.current_group = []
            self.progress.current_group = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –≤–µ—Ö–∏
            if len(self.progress.stage2_selected) % 3 == 0:
                self._add_badge(f"–§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä {len(self.progress.stage2_selected)//3}")
            
            self._update_activity()
            self._save_progress()
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ —ç—Ç–∞–ø–∞ 2: {e}")
            self._update_stats(error=True)
            return False
    
    def _add_badge(self, badge_name: str):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è"""
        if badge_name not in self.progress.badges:
            self.progress.badges.append(badge_name)
            self._save_progress()
    
    def get_progress(self) -> Dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä—ã"""
        if self.progress.stage == 1:
            current = len(self.progress.stage1_selected)
            target = self.total_rounds_stage1
            stage_text = "–≠—Ç–∞–ø 1: –í—ã–±–æ—Ä 40 –∏–∑ 200"
            percent = (current / target * 100) if target > 0 else 0
        else:
            current = len(self.progress.stage2_selected)
            target = self.total_rounds_stage2
            stage_text = "–≠—Ç–∞–ø 2: –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä 10 –∏–∑ 40"
            percent = (current / target * 100) if target > 0 else 0
        
        return {
            "stage": self.progress.stage,
            "stage_text": stage_text,
            "current": current,
            "target": target,
            "percent": round(percent, 1),
            "round": self.progress.round,
            "badges": self.progress.badges[-3:] if self.progress.badges else []
        }
    
    def is_complete(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ –∏–≥—Ä–∞"""
        return (self.progress.stage == 2 and 
                len(self.progress.stage2_selected) >= self.total_rounds_stage2)
    
    def get_final_values(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ 10 —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π"""
        final_ids = self.progress.stage2_selected[:10]
        return [VALUE_BY_ID[id] for id in final_ids if id in VALUE_BY_ID]
    
    def analyze_psychological_profile(self):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å"""
        categories = {}
        final_values = self.get_final_values()
        
        for value in final_values:
            cat = value.get('category', '–†–∞–∑–Ω–æ–µ')
            categories[cat] = categories.get(cat, 0) + 1
        
        if not categories:
            self.progress.psychological_profile = '–±–∞–ª–∞–Ω—Å'
            return
        
        main_category = max(categories.items(), key=lambda x: x[1])[0]
        
        profile_map = {
            '—Ä–∞–¥–æ—Å—Ç—å': '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ',
            '–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ': '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
            '–º–æ—Ç–∏–≤–∞—Ü–∏—è': '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
            '–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å': '–±–∞–ª–∞–Ω—Å',
            '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ': '–±–∞–ª–∞–Ω—Å',
            '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ': '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ',
            '—á–µ—Å—Ç–Ω–æ—Å—Ç—å': '–æ—Ç–Ω–æ—à–µ–Ω–∏—è',
            '—Ä–∞–∑–≤–∏—Ç–∏–µ': '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
            '–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞': '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
            '–æ—Ç–Ω–æ—à–µ–Ω–∏—è': '–æ—Ç–Ω–æ—à–µ–Ω–∏—è'
        }
        
        self.progress.psychological_profile = profile_map.get(main_category, '–±–∞–ª–∞–Ω—Å')
        self._save_progress()

# ========== –ë–û–¢ –ò –î–ò–°–ü–ï–¢–ß–ï–† ==========
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
progress_storage = ProgressStorage()
timeout_manager = TimeoutManager()
active_games: Dict[int, ValueGame] = {}

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def get_main_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢")],
            [KeyboardButton(text="üìä –ü–†–û–ì–†–ï–°–°"), KeyboardButton(text="‚ùì –ü–û–ú–û–©–¨")],
            [KeyboardButton(text="üì± –ü–û–î–ï–õ–ò–¢–¨–°–Ø –ë–û–¢–û–ú")]
        ],
        resize_keyboard=True,
        one_time_keyboard=False
    )

def get_choice_keyboard_5():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="1Ô∏è‚É£"), KeyboardButton(text="2Ô∏è‚É£"), KeyboardButton(text="3Ô∏è‚É£")],
            [KeyboardButton(text="4Ô∏è‚É£"), KeyboardButton(text="5Ô∏è‚É£")],
            [KeyboardButton(text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–∞—É–Ω–¥"), KeyboardButton(text="üìä –ü—Ä–æ–≥—Ä–µ—Å—Å")]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )

def get_choice_keyboard_4():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="A"), KeyboardButton(text="B")],
            [KeyboardButton(text="C"), KeyboardButton(text="D")],
            [KeyboardButton(text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–∞—É–Ω–¥"), KeyboardButton(text="üìä –ü—Ä–æ–≥—Ä–µ—Å—Å")]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )

def get_goals_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üöÄ –ö–∞—Ä—å–µ—Ä–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è")],
            [KeyboardButton(text="üíº –ë–∏–∑–Ω–µ—Å –∏ —Ñ–∏–Ω–∞–Ω—Å—ã")],
            [KeyboardButton(text="üß† –õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç")],
            [KeyboardButton(text="‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Å–µ–º—å—è")],
            [KeyboardButton(text="‚öñÔ∏è –ë–∞–ª–∞–Ω—Å –∏ –≥–∞—Ä–º–æ–Ω–∏—è")],
            [KeyboardButton(text="üéØ –î—Ä—É–≥–∞—è —Ü–µ–ª—å")]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )

def get_share_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞ –±–æ—Ç–∞"""
    share_text = (
        "üéØ –û—Ç–∫—Ä–æ–π —Å–≤–æ–∏ –∏—Å—Ç–∏–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏!\n"
        "–ü—Ä–æ–π–¥–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é 10 –≥–ª–∞–≤–Ω—ã—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π.\n"
        "https://t.me/cennostibot"
    )
    
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram", 
                                 url=f"https://t.me/share/url?url=https://t.me/cennostibot&text={share_text}")],
            [InlineKeyboardButton(text="üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data="copy_link")],
            [InlineKeyboardButton(text="üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞", url=f"https://t.me/share/url?url=https://t.me/cennostibot")]
        ]
    )

# ========== –ú–û–¢–ò–í–ê–¶–ò–û–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ==========
MOTIVATIONAL_MESSAGES = {
    10: "üéØ –û—Ç–ª–∏—á–Ω–æ! –í—ã —É–∂–µ –æ—Ç–æ–±—Ä–∞–ª–∏ 25% —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. –≠—Ç–æ –≤–∞–∂–Ω—ã–π —ç—Ç–∞–ø —Å–∞–º–æ–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è!",
    20: "üöÄ –ü–æ—Ç—Ä—è—Å–∞—é—â–µ! –ü–æ–ª–æ–≤–∏–Ω–∞ –ø—É—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞. –í–∞—à–∏ –∏—Å—Ç–∏–Ω–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —è—Å–Ω–µ–µ.",
    30: "üåü –í—ã –Ω–∞ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø—Ä—è–º–æ–π –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞! –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–æ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.",
    5: "üîç –û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —ç—Ç–∞–ø–∞! –°–µ–π—á–∞—Å –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.",
    8: "üíé –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ! –û—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ, —Å–∞–º—ã–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä—ã."
}

# ========== –û–°–ù–û–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
@dp.message(Command("start"))
@dp.message(F.text == "üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢")
async def cmd_start(message: types.Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –∏–≥—Ä—ã"""
    user_id = message.from_user.id
    username = message.from_user.full_name or "–ò–≥—Ä–æ–∫"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–∞—É—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    timeout_manager.stop_timeout_check(user_id)
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    progress_storage.delete(user_id)
    if user_id in active_games:
        del active_games[user_id]
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
    game = ValueGame(user_id, username, progress_storage)
    active_games[user_id] = game
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–π–º–∞—É—Ç–∞
    await timeout_manager.start_timeout_check(user_id, state, bot)
    
    rules = f"""
üéØ <b>–¢–ï–°–¢ ¬´–ú–û–ò –¶–ï–ù–ù–û–°–¢–ò¬ª</b>

üëã –ü—Ä–∏–≤–µ—Ç, {username}!

‚ú® <b>–ß–¢–û –í–ê–° –ñ–î–ï–¢:</b>
1. <b>–≠—Ç–∞–ø 1:</b> 40 —Ä–∞—É–Ω–¥–æ–≤ √ó –≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 5
2. <b>–≠—Ç–∞–ø 2:</b> 10 —Ä–∞—É–Ω–¥–æ–≤ √ó –≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 4
3. <b>–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</b> –≤–∞—à–∏—Ö 10 –≥–ª–∞–≤–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
4. <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b> –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è

‚è±Ô∏è <b>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!</b>
–ú–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ.

üöÄ <b>–ù–∞—á–∏–Ω–∞–µ–º 1 —ç—Ç–∞–ø!</b>
"""
    
    await message.answer(rules, reply_markup=ReplyKeyboardRemove())
    await state.set_state(GameStates.stage1_round)
    await send_next_round(message, game, state)

async def send_next_round(message: types.Message, game: ValueGame, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥"""
    user_id = message.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
    timeout_manager.stop_timeout_check(user_id)
    await timeout_manager.start_timeout_check(user_id, state, bot)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞/–∏–≥—Ä—ã
    if game.progress.stage == 1 and len(game.progress.stage1_selected) >= game.total_rounds_stage1:
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç—Ç–∞–ø—É 2
        game.progress.stage = 2
        progress_storage.set(user_id, game.progress)
        await state.set_state(GameStates.stage2_round)
        await send_stage_transition(message, game, state)
        return
    elif game.is_complete():
        # –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –æ —Ü–µ–ª—è—Ö
        timeout_manager.stop_timeout_check(user_id)
        await ask_about_goals(message, game, state)
        return
    
    progress = game.get_progress()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if progress["current"] in MOTIVATIONAL_MESSAGES:
        await message.answer(MOTIVATIONAL_MESSAGES[progress["current"]], reply_markup=ReplyKeyboardRemove())
        await asyncio.sleep(1)
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—É–Ω–¥
    if game.progress.stage == 1:
        if not game.prepare_stage1_round():
            # –ó–∞–≤–µ—Ä—à–∞–µ–º —ç—Ç–∞–ø 1
            game.progress.stage = 2
            progress_storage.set(user_id, game.progress)
            await state.set_state(GameStates.stage2_round)
            await send_stage_transition(message, game, state)
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —ç—Ç–∞–ø–∞ 1
        text = f"""
<b>üéØ –≠–¢–ê–ü 1: –í–´–ë–ï–†–ò–¢–ï 1 –ò–ó 5</b>

{get_progress_bar(progress["percent"])}
üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress["current"]}/{progress["target"]} ({progress["percent"]}%)
üéØ <b>–†–∞—É–Ω–¥:</b> {progress["round"]}

<b>–ö–∞–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ?</b>
"""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω–Ω–æ—Å—Ç–∏
        for i, value in enumerate(game.current_group, 1):
            text += f"\n{i}Ô∏è‚É£ <b>{value['name']}</b>"
            if value.get('description'):
                text += f"\n<em>{value['description']}</em>"
            text += "\n"
        
        text += "\n<b>–ù–∞–∂–º–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–Ω–æ–ø–∫–∏ (1-5)</b>"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if progress["badges"]:
            text += f"\n\nüèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(progress['badges'])}"
        
        await message.answer(text, reply_markup=get_choice_keyboard_5())
        
    else:  # stage == 2
        if not game.prepare_stage2_round():
            # –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É
            timeout_manager.stop_timeout_check(user_id)
            await ask_about_goals(message, game, state)
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —ç—Ç–∞–ø–∞ 2
        text = f"""
<b>üéØ –≠–¢–ê–ü 2: –í–´–ë–ï–†–ò–¢–ï 1 –ò–ó 4</b>

{get_progress_bar(progress["percent"])}
üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress["current"]}/{progress["target"]} ({progress["percent"]}%)
üéØ <b>–†–∞—É–Ω–¥:</b> {progress["round"]}

<b>–ö–∞–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏?</b>
"""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Å –±—É–∫–≤–∞–º–∏
        letters = ['A', 'B', 'C', 'D']
        for i, value in enumerate(game.current_group):
            text += f"\n{letters[i]}. <b>{value['name']}</b>"
            if value.get('description'):
                text += f"\n<em>{value['description']}</em>"
            text += "\n"
        
        text += "\n<b>–ù–∞–∂–º–∏—Ç–µ –±—É–∫–≤—É –∫–Ω–æ–ø–∫–∏ (A-D)</b>"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if progress["badges"]:
            text += f"\n\nüèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(progress['badges'])}"
        
        await message.answer(text, reply_markup=get_choice_keyboard_4())

def get_progress_bar(percent: float, length: int = 10) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä"""
    filled = int(percent / 100 * length)
    empty = length - filled
    bar = "‚ñà" * filled + "‚ñë" * empty
    return f"[{bar}]"

async def send_stage_transition(message: types.Message, game: ValueGame, state: FSMContext):
    """–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏"""
    
    transition_text = f"""
üéâ <b>–≠–¢–ê–ü 1 –ó–ê–í–ï–†–®–ï–ù!</b>

‚úÖ –í—ã –æ—Ç–æ–±—Ä–∞–ª–∏: {len(game.progress.stage1_selected)} —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –∏–∑ 200
üèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(game.progress.badges[-3:]) if game.progress.badges else '–ü–æ–∫–∞ –Ω–µ—Ç'}

‚û°Ô∏è <b>–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —ç—Ç–∞–ø—É 2</b>

–¢–µ–ø–µ—Ä—å –±—É–¥–µ–º –≤—ã–±–∏—Ä–∞—Ç—å –∏–∑ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –ø–æ —Ç–µ–º–∞—Ç–∏–∫–µ.
–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–æ–æ–±—Ä–∞–∑—É—é—â–∏–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏.

–ù–∞–∂–º–∏—Ç–µ /continue —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–±–æ—Ä!
"""
    
    await message.answer(transition_text, reply_markup=ReplyKeyboardRemove())

@dp.message(Command("continue"))
async def cmd_continue(message: types.Message, state: FSMContext):
    """–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        await message.answer("üéÆ –°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç", reply_markup=get_main_keyboard())
        return
    
    game = active_games[user_id]
    await send_next_round(message, game, state)

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –° –í–ê–õ–ò–î–ê–¶–ò–ï–ô ==========
@dp.message(F.text.in_(["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "1", "2", "3", "4", "5"]))
async def handle_stage1_choice(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞ —ç—Ç–∞–ø–µ 1 (1-5) —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        await handle_invalid_input(message, "–í—ã–±–æ—Ä –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ: üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢")
        return
    
    game = active_games[user_id]
    current_state = await state.get_state()
    
    if current_state != GameStates.stage1_round:
        await handle_invalid_input(message, "–°–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è –¥–ª—è –≤—ã–±–æ—Ä–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ—Å—Ç.")
        return
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–≤–æ–¥ –≤ –∏–Ω–¥–µ–∫—Å
    text = message.text.replace("Ô∏è‚É£", "")
    try:
        choice_index = int(text) - 1
    except:
        await handle_invalid_input(message, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 1Ô∏è‚É£, 2Ô∏è‚É£, 3Ô∏è‚É£, 4Ô∏è‚É£ –∏–ª–∏ 5Ô∏è‚É£")
        return
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
    if not hasattr(game, 'current_group') or not game.current_group:
        await handle_invalid_input(message, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return
    
    if not (0 <= choice_index < len(game.current_group)):
        await handle_invalid_input(message, f"–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ {len(game.current_group)}")
        return
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
    start_time = time.time()
    success = game.process_stage1_choice(choice_index)
    choice_time = time.time() - start_time
    
    if success:
        game._update_stats(choice_time=choice_time)
        await send_next_round(message, game, state)
    else:
        await handle_invalid_input(message, "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(F.text.in_(["A", "B", "C", "D", "a", "b", "c", "d"]))
async def handle_stage2_choice(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞ —ç—Ç–∞–ø–µ 2 (A-D) —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        await handle_invalid_input(message, "–í—ã–±–æ—Ä –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ: üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢")
        return
    
    game = active_games[user_id]
    current_state = await state.get_state()
    
    if current_state != GameStates.stage2_round:
        await handle_invalid_input(message, "–°–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è –¥–ª—è –≤—ã–±–æ—Ä–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ—Å—Ç.")
        return
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–≤–æ–¥ –≤ –∏–Ω–¥–µ–∫—Å
    text = message.text.upper()
    letter_to_index = {'A': 0, 'B': 1, 'C': 2, 'D': 3}
    
    if text not in letter_to_index:
        await handle_invalid_input(message, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É A, B, C –∏–ª–∏ D")
        return
    
    choice_index = letter_to_index[text]
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
    if not hasattr(game, 'current_group') or not game.current_group:
        await handle_invalid_input(message, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ /continue")
        return
    
    if not (0 <= choice_index < len(game.current_group)):
        await handle_invalid_input(message, f"–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–≤—É –æ—Ç A –¥–æ {chr(65 + len(game.current_group) - 1)}")
        return
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
    start_time = time.time()
    success = game.process_stage2_choice(choice_index)
    choice_time = time.time() - start_time
    
    if success:
        game._update_stats(choice_time=choice_time)
        await send_next_round(message, game, state)
    else:
        await handle_invalid_input(message, "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

async def handle_invalid_input(message: types.Message, error_msg: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –≤–≤–æ–¥–∞"""
    await message.answer(
        f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {error_msg}\n\n"
        f"<i>–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ: üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢</i>",
        reply_markup=ReplyKeyboardRemove()
    )

@dp.message(F.text == "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–∞—É–Ω–¥")
async def handle_skip(message: types.Message, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫ —Ä–∞—É–Ω–¥–∞"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        return
    
    game = active_games[user_id]
    current_state = await state.get_state()
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å
    if current_state == GameStates.stage1_round:
        if hasattr(game, 'current_group') and game.current_group:
            choice_index = random.randint(0, len(game.current_group) - 1)
            success = game.process_stage1_choice(choice_index)
            if success:
                game._update_stats(skipped=True)
    elif current_state == GameStates.stage2_round:
        if hasattr(game, 'current_group') and game.current_group:
            choice_index = random.randint(0, len(game.current_group) - 1)
            success = game.process_stage2_choice(choice_index)
            if success:
                game._update_stats(skipped=True)
    
    await message.answer("‚è≠Ô∏è –†–∞—É–Ω–¥ –ø—Ä–æ–ø—É—â–µ–Ω. –°–ª–µ–¥—É—é—â–∏–π –≤—ã–±–æ—Ä...", reply_markup=ReplyKeyboardRemove())
    await send_next_round(message, game, state)

# ========== –ê–ù–ê–õ–ò–ó –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ==========
async def ask_about_goals(message: types.Message, game: ValueGame, state: FSMContext):
    """–°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ —Ü–µ–ª—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    final_values = game.get_final_values()
    
    result_text = f"""
üéâ <b>–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú, {game.username}!</b>

‚úÖ <b>–¢–ï–°–¢ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù</b>

üèÜ <b>–í–ê–®–ò 10 –ì–õ–ê–í–ù–´–• –¶–ï–ù–ù–û–°–¢–ï–ô:</b>

"""
    
    for i, value in enumerate(final_values, 1):
        result_text += f"\n{i}. <b>{value['name']}</b>"
        if value.get('description'):
            result_text += f"\n   <em>{value['description']}</em>"
        if value.get('category'):
            result_text += f"\n   üè∑Ô∏è {value['category']}"
        result_text += "\n"
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = game.progress.stats
    avg_time = stats["avg_response_time"]
    total_choices = stats["total_choices"]
    
    result_text += f"""
üìä <b>–°–¢–ê–¢–ò–°–¢–ò–ö–ê:</b>
‚Ä¢ –ù–∞—á–∞–ª–æ: {len(ALL_VALUES)} —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
‚Ä¢ –≠—Ç–∞–ø 1: –æ—Ç–æ–±—Ä–∞–Ω–æ 40 –∏–∑ 200
‚Ä¢ –≠—Ç–∞–ø 2: –≤—ã–±—Ä–∞–Ω–æ 10 –≥–ª–∞–≤–Ω—ã—Ö
‚Ä¢ –†–∞—É–Ω–¥–æ–≤: {game.progress.round}
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {avg_time:.1f} —Å–µ–∫
‚Ä¢ –í—Å–µ–≥–æ –≤—ã–±–æ—Ä–æ–≤: {total_choices}
‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ —Ä–∞—É–Ω–¥–æ–≤: {stats['skipped_rounds']}
‚Ä¢ –û—à–∏–±–æ–∫ –≤–≤–æ–¥–∞: {stats['errors']}

üéØ <b>–î–õ–Ø –¢–û–ß–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê:</b>
"""
    
    await message.answer(result_text, reply_markup=ReplyKeyboardRemove())
    await asyncio.sleep(2)
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –æ —Ü–µ–ª—è—Ö
    goals_text = f"""
üîç <b>–ù–∞ –∫–∞–∫–æ–π —Å—Ñ–µ—Ä–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è, {game.username}?</b>

–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 3-6 –º–µ—Å—è—Ü–µ–≤:

<em>–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∑–¥–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</em>
"""
    
    await message.answer(goals_text, reply_markup=get_goals_keyboard())
    await state.set_state(GameStates.asking_goals)

@dp.message(GameStates.asking_goals)
async def handle_goals_input(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ü–µ–ª–µ–π"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        await message.answer("üéÆ –°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç", reply_markup=get_main_keyboard())
        return
    
    game = active_games[user_id]
    goals_input = message.text.strip()
    game.progress.user_goals = goals_input
    game._save_progress()
    
    await state.set_state(GameStates.generating_analysis)
    await generate_deep_analysis_report(message, game, state)

async def generate_deep_analysis_report(message: types.Message, game: ValueGame, state: FSMContext):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑"""
    
    game.analyze_psychological_profile()
    
    # –ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞
    analysis_start = f"""
üîÆ <b>–ù–ê–ß–ò–ù–ê–Æ –ì–õ–£–ë–û–ö–ò–ô –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó</b>

‚è±Ô∏è <em>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –¥–ª—è {game.username}...</em>

‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã 10 –≥–ª–∞–≤–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π
‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –¥–ª—è —Ü–µ–ª–∏: <b>{game.progress.user_goals}</b>

<i>–≠—Ç–æ –∑–∞–π–º–µ—Ç –æ–∫–æ–ª–æ 30 —Å–µ–∫—É–Ω–¥</i>
"""
    
    await message.answer(analysis_start, reply_markup=ReplyKeyboardRemove())
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
    processing_msg = await message.answer("üîÑ <i>–ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã... 0%</i>")
    
    for percent in range(10, 101, 10):
        await asyncio.sleep(2.5)
        if percent < 40:
            await processing_msg.edit_text(f"üß† <i>–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑... {percent}%</i>")
        elif percent < 70:
            await processing_msg.edit_text(f"üìä <i>–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π... {percent}%</i>")
        else:
            await processing_msg.edit_text(f"‚ú® <i>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞... {percent}%</i>")
    
    await processing_msg.delete()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑)
    await show_deep_analysis_final(message, game, state)

async def show_deep_analysis_final(message: types.Message, game: ValueGame, state: FSMContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑"""
    
    # –ß–∞—Å—Ç—å 1: –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑
    analysis = f"""
üé≠ <b>–ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–û–†–¢–†–ï–¢</b>

<em>–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ 10 —Å–∏—Å—Ç–µ–º–æ–æ–±—Ä–∞–∑—É—é—â–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π</em>

‚ú® <b>–ü—Ä–æ—Ñ–∏–ª—å:</b> {game.progress.psychological_profile.upper() if game.progress.psychological_profile else '–ë–ê–õ–ê–ù–°'}
üìà <b>–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞:</b> –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
‚ö° <b>–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω:</b> –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π

üåü <b>–ö–ª—é—á–µ–≤—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:</b>
{random.choice(DEEP_STRENGTHS_ANALYSIS.get(game.progress.psychological_profile or '–±–∞–ª–∞–Ω—Å', DEEP_STRENGTHS_ANALYSIS['–±–∞–ª–∞–Ω—Å']))}

‚ö° <b>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏:</b>
{random.choice(DEEP_ENERGY_DISTRIBUTION.get(game.progress.psychological_profile or '–±–∞–ª–∞–Ω—Å', DEEP_ENERGY_DISTRIBUTION['–±–∞–ª–∞–Ω—Å']))}

üéØ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ü–µ–ª–∏ "{game.progress.user_goals}":</b>
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–∏ 2-3 –∫–ª—é—á–µ–≤—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–π —Ü–µ–ª–∏.
–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –º–∏–∫—Ä–æ-–¥–µ–π—Å—Ç–≤–∏—è, —É–∫—Ä–µ–ø–ª—è—é—â–∏–µ —ç—Ç–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.

üìö <b>3 –∫–Ω–∏–≥–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è:</b>
1. ¬´–°–∏–ª–∞ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ¬ª - –≠–∫—Ö–∞—Ä—Ç –¢–æ–ª–ª–µ
2. ¬´–ê—Ç–æ–º–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏¬ª - –î–∂–µ–π–º—Å –ö–ª–∏—Ä  
3. ¬´–î—Ä–∞–π–≤¬ª - –î—ç–Ω–∏–µ–ª –ü–∏–Ω–∫

üíé <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ 90 –¥–Ω–µ–π:</b>
1. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π 10-–º–∏–Ω—É—Ç–Ω—ã–π —Ä–∏—Ç—É–∞–ª —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
2. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–µ–π—Å—Ç–≤–∏–π —Ü–µ–Ω–Ω–æ—Å—Ç—è–º
3. –ú–µ—Å—è—á–Ω—ã–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ —É—Å–∏–ª–µ–Ω–∏—é —Å–∞–º–æ–π —Å–ª–∞–±–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
"""
    
    await message.answer(analysis, reply_markup=ReplyKeyboardRemove())
    await asyncio.sleep(2)
    
    # –ß–∞—Å—Ç—å 2: –®–∞—Ä–∏–Ω–≥ –∏ —ç–∫—Å–ø–æ—Ä—Ç
    share_text = f"""
üéâ <b>–í–ê–® –¶–ï–ù–ù–û–°–¢–ù–´–ô –ö–û–ú–ü–ê–° –ì–û–¢–û–í!</b>

‚ú® <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:</b>
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ (—Å–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç)
2. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Å –±–ª–∏–∑–∫–∏–º–∏
3. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–Ω–∞–ª–∏–∑—É –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö
4. –ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 3-6 –º–µ—Å—è—Ü–µ–≤

üîó <b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –±–æ—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏:</b>
"""
    
    await message.answer(share_text, reply_markup=get_share_keyboard())
    
    # –ß–∞—Å—Ç—å 3: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    final_msg = f"""
üìä <b>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∞:</b>
‚Ä¢ –í—Å–µ–≥–æ —Ä–∞—É–Ω–¥–æ–≤: {game.progress.round}
‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: {', '.join(game.progress.badges) if game.progress.badges else '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏'}
‚Ä¢ –î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è: {datetime.now().strftime('%d.%m.%Y %H:%M')}

üîÑ <b>–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Å–Ω–æ–≤–∞ (–¥–ª—è –¥—Ä—É–≥–æ–π —Å—Ñ–µ—Ä—ã):</b> üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢

üí° <b>–°–æ–≤–µ—Ç:</b> –í–∞—à–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ - —ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π GPS. 
–î–æ–≤–µ—Ä—è–π—Ç–µ –µ–º—É, –∏ –æ–Ω –ø—Ä–∏–≤–µ–¥–µ—Ç –≤–∞—Å –∫ –ø–æ–¥–ª–∏–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
"""
    
    await message.answer(final_msg, reply_markup=get_main_keyboard())
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()
    timeout_manager.stop_timeout_check(user_id := message.from_user.id)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    game._save_progress()

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –®–ê–†–ò–ù–ì–ê ==========
@dp.callback_query(F.data == "copy_link")
async def handle_copy_link(callback_query: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏"""
    await callback_query.answer("üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞")
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ª–æ–≥–∏–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏

@dp.message(F.text == "üì± –ü–û–î–ï–õ–ò–¢–¨–°–Ø –ë–û–¢–û–ú")
async def handle_share_command(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã —à–∞—Ä–∏–Ω–≥–∞"""
    share_text = (
        "üéØ –û—Ç–∫—Ä–æ–π —Å–≤–æ–∏ –∏—Å—Ç–∏–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏!\n\n"
        "–Ø –ø—Ä–æ—à–µ–ª —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é 10 –≥–ª–∞–≤–Ω—ã—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π. "
        "–û—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é - —ç—Ç–æ –ø–æ–º–æ–≥–ª–æ –º–Ω–µ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–µ–±—è –∏ —Å–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.\n\n"
        "–ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã: https://t.me/cennostibot"
    )
    
    await message.answer(
        "üì± <b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –±–æ—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏</b>\n\n"
        "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –¥—Ä—É–∑—å—è–º –æ —Å–≤–æ–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –∏—Ö –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç:\n\n"
        f"<code>{share_text}</code>",
        reply_markup=get_share_keyboard()
    )

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
@dp.message(Command("progress"))
@dp.message(F.text == "üìä –ü–†–û–ì–†–ï–°–°")
async def cmd_progress(message: types.Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        progress = progress_storage.get(user_id)
        if progress:
            game = ValueGame(user_id, progress.username, progress_storage)
            active_games[user_id] = game
        else:
            await message.answer("üéÆ –°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç", reply_markup=get_main_keyboard())
            return
    
    game = active_games[user_id]
    progress = game.get_progress()
    
    start_time = datetime.fromisoformat(game.progress.start_time)
    elapsed = datetime.now() - start_time
    mins = elapsed.seconds // 60
    secs = elapsed.seconds % 60
    
    stats_text = f"""
üìä <b>–ü–†–û–ì–†–ï–°–° –¢–ï–°–¢–ê</b>

<b>{progress['stage_text']}</b>
{get_progress_bar(progress['percent'])}
‚úÖ <b>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</b> {progress['percent']}%
üéØ <b>–û—Ç–æ–±—Ä–∞–Ω–æ:</b> {progress['current']} –∏–∑ {progress['target']}
üîÑ <b>–†–∞—É–Ω–¥–æ–≤:</b> {progress['round']}
‚è±Ô∏è <b>–í—Ä–µ–º—è:</b> {mins} –º–∏–Ω {secs} —Å–µ–∫
"""
    
    if progress['badges']:
        stats_text += f"\nüèÜ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b> {', '.join(progress['badges'])}"
    
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_stats = game.progress.stats
    stats_text += f"""
    
üìà <b>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ –í—Å–µ–≥–æ –≤—ã–±–æ—Ä–æ–≤: {total_stats['total_choices']}
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {total_stats['avg_response_time']:.1f} —Å–µ–∫
‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–æ: {total_stats['skipped_rounds']} —Ä–∞—É–Ω–¥–æ–≤
‚Ä¢ –û—à–∏–±–æ–∫: {total_stats['errors']}
"""
    
    await message.answer(stats_text, reply_markup=ReplyKeyboardRemove())

@dp.message(Command("help"))
@dp.message(F.text == "‚ùì –ü–û–ú–û–©–¨")
async def cmd_help(message: types.Message):
    help_text = f"""
‚ùì <b>–ü–û–ú–û–©–¨ - {BOT_NAME}</b>

<b>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</b>
‚Ä¢ –ù–∞–∂–∏–º–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ (1-5) –∏–ª–∏ –±—É–∫–≤–∞–º–∏ (A-D)
‚Ä¢ –í—ã–±–∏—Ä–∞–π—Ç–µ –æ–¥–Ω—É —Ü–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ
‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

<b>–≠—Ç–∞–ø—ã:</b>
1. <b>–≠—Ç–∞–ø 1:</b> 40 —Ä–∞—É–Ω–¥–æ–≤ √ó –≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 5
2. <b>–≠—Ç–∞–ø 2:</b> 10 —Ä–∞—É–Ω–¥–æ–≤ √ó –≤—ã–±—Ä–∞—Ç—å 1 –∏–∑ 4

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
üéÆ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢ - –Ω–∞—á–∞—Ç—å/–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç
üìä –ü–†–û–ì–†–ï–°–° - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
‚ùì –ü–û–ú–û–©–¨ - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
üì± –ü–û–î–ï–õ–ò–¢–¨–°–Ø –ë–û–¢–û–ú - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º

<b>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚Ä¢ –¢–∞–π–º–∞—É—Ç—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π

<b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>
@DubkovMaxim
"""
    await message.answer(help_text, reply_markup=get_main_keyboard())

@dp.message(Command("export"))
async def cmd_export(message: types.Message):
    """–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
    user_id = message.from_user.id
    
    if user_id not in active_games:
        await message.answer("üéÆ –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç", reply_markup=get_main_keyboard())
        return
    
    game = active_games[user_id]
    
    if not game.is_complete():
        await message.answer("üìù –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ—Å—Ç —á—Ç–æ–±—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", reply_markup=ReplyKeyboardRemove())
        return
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    export_text = f"""
–¶–ï–ù–ù–û–°–¢–ù–´–ô –ù–ê–í–ò–ì–ê–¢–û–† - –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ê
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {game.username}
–î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}

10 –ì–õ–ê–í–ù–´–• –¶–ï–ù–ù–û–°–¢–ï–ô:
"""
    
    for i, value in enumerate(game.get_final_values(), 1):
        export_text += f"\n{i}. {value['name']} - {value.get('description', '')}"
    
    export_text += f"""
    
–°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –í—Å–µ–≥–æ —Ä–∞—É–Ω–¥–æ–≤: {game.progress.round}
‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è: {', '.join(game.progress.badges)}
‚Ä¢ –¶–µ–ª—å: {game.progress.user_goals}
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª—å: {game.progress.psychological_profile}

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –¥–ª—è —Å–µ–±—è –∏–ª–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –∫–æ—É—á–µ–º/–ø—Å–∏—Ö–æ–ª–æ–≥–æ–º.
"""
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã —ç–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª
    await message.answer(
        "üìÑ <b>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</b>\n\n"
        "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö:\n\n"
        f"<code>{export_text[:2000]}...</code>\n\n"
        "<i>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞.</i>",
        reply_markup=ReplyKeyboardRemove()
    )

# ========== –ü–ò–ù–ì –î–õ–Ø RAILWAY ==========
@dp.message(Command("ping"))
async def cmd_ping(message: types.Message):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
    await message.answer("üèì Pong! –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.")

# ========== –ó–ê–ü–£–°–ö –ò –ü–û–î–î–ï–†–ñ–ö–ê –ñ–ò–ó–ù–ï–°–ü–û–°–û–ë–ù–û–°–¢–ò ==========
async def keep_alive():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã Railway"""
    while True:
        try:
            # –ü—Ä–æ—Å—Ç–æ —Å–ø–∞—Ç—å - Railway –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∞–∫—Ç–∏–≤–µ–Ω
            await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç
        except asyncio.CancelledError:
            break
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ keep_alive: {e}")

async def cleanup_old_sessions():
    """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π"""
    while True:
        try:
            await asyncio.sleep(3600)  # –ö–∞–∂–¥—ã–π —á–∞—Å
            progress_storage.cleanup_old_sessions()
            logger.info("–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π")
        except asyncio.CancelledError:
            break
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ cleanup_old_sessions: {e}")

# ========== –ó–ê–ü–£–°–ö ==========
async def main():
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π...")
    
    if not BOT_TOKEN or BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê":
        logger.error("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
        
        if ENVIRONMENT == "production":
            logger.error("‚ùå –í production —Ä–µ–∂–∏–º–µ BOT_TOKEN –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!")
            return
        
        logger.warning("‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)")
    
    try:
        bot_info = await bot.get_me()
        logger.info(f"‚úÖ –ë–æ—Ç @{bot_info.username} –∑–∞–ø—É—â–µ–Ω!")
        logger.info(f"‚úÖ {len(ALL_VALUES)} —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞")
        logger.info(f"‚úÖ –†–µ–∂–∏–º: {ENVIRONMENT}")
        logger.info("‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–∫—Ç–∏–≤–Ω–∞")
        logger.info("‚úÖ –¢–∞–π–º–∞—É—Ç—ã –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã")
        logger.info("‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
        keep_alive_task = asyncio.create_task(keep_alive())
        cleanup_task = asyncio.create_task(cleanup_old_sessions())
        
        try:
            await dp.start_polling(bot)
        finally:
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
            keep_alive_task.cancel()
            cleanup_task.cancel()
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            progress_storage.save()
            logger.info("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: {e}", exc_info=True)
        
        if ENVIRONMENT == "production":
            logger.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ production!")
        else:
            input("–ù–∞–∂–º–∏—Ç–µ Enter...")

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
